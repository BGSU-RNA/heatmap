#!/usr/bin/env python

import os
import re
import csv
import sys
import json


def load_data(raw, family):
    reader = csv.DictReader(raw, delimiter=',')
    data = {'items': {}, 'pairs': []}

    for row in reader:
        first = row['Base combination']
        family = row['Family']
        if family[1] != family[2]:
            pass

        data['items'][first] = {
            'units': [row['NT1ID'], row['NT2ID']],
            'pdb': row['PDBID'],
            'resolution': row['Resolution'],
            'group': row['LW 2002 subgroup'],
            'family': family,
            'distance': row['C1*-C1* distance'],
            'count': row['Count']
        }
        for key, value in row.items():
            if re.match('^[ACGU]{2}$', key):
                data['pairs'].append({
                    'idi': row[key],
                    "item1": first,
                    "item2": key
                })

    return data


def save(data):
    json.dump(data, sys.stdout)


def main(filename):
    name = os.path.basename(filename)[0:3]
    with open(filename, 'rb') as raw:
        data = load_data(raw, name)
    save(data)

if __name__ == '__main__':
    main(sys.argv[1])
